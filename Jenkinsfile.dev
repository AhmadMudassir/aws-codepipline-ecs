pipeline {
  agent { label 'node1' }

  stages {
    stage('Install Dependencies') {
      steps {
        sh '''
          ls -a
          npm i express
        '''
      }
    }

    stage('Start or Restart App with PM2') {
      steps {
        sh '''
          if pm2 list | grep -q "node-app"; then
            echo "App is running, restarting with PM2..."
            pm2 restart node-app
          else
            echo "App is not running, starting with PM2..."
            pm2 start index.js --name node-app
          fi

          pm2 save
        '''
      }
    }
  }
}
